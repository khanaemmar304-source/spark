<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>âš¡ Spark - Startup Idea Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background: radial-gradient(circle at top left, #1a1a2e, #000);
      color: #fff;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
    }
    .glass {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(12px);
    }
    .spark-gradient {
      background: linear-gradient(90deg, #7b2ff7, #f107a3);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .idea-card {
      transition: all 0.3s ease;
    }
    .idea-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(255, 255, 255, 0.15);
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- NAVBAR -->
  <nav class="w-full flex justify-between items-center p-4 glass fixed top-0 left-0 z-20">
    <h1 class="text-2xl font-bold spark-gradient">âš¡ Spark</h1>
    <div class="space-x-4">
      <button id="aboutBtn" class="hover:text-pink-400">About</button>
      <button id="logoutBtn" class="hover:text-pink-400 hidden">Logout</button>
    </div>
  </nav>

  <!-- LOGIN SECTION -->
  <div id="loginSection" class="w-full max-w-md mx-auto glass rounded-2xl p-6 text-center mt-32">
    <h1 class="text-4xl font-bold mb-4 spark-gradient">Sign In / Sign Up</h1>
    <input id="email" type="email" placeholder="Email" class="w-full bg-transparent border border-gray-600 rounded-lg p-3 mb-3 text-white focus:ring-2 focus:ring-pink-500 outline-none" />
    <input id="password" type="password" placeholder="Password" class="w-full bg-transparent border border-gray-600 rounded-lg p-3 mb-4 text-white focus:ring-2 focus:ring-pink-500 outline-none" />
    <button id="loginBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-500 hover:opacity-90 text-white font-bold py-3 rounded-lg transition">Login / Signup</button>
    <p id="loginStatus" class="mt-3 text-sm text-gray-400"></p>
  </div>

  <!-- MAIN SECTION -->
  <div id="mainSection" class="hidden flex flex-row w-full h-screen mt-16">
    <!-- SIDEBAR -->
    <div class="w-64 glass flex flex-col p-4 space-y-3 border-r border-gray-800">
      <button id="generateIdeaBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-500 py-2 rounded-lg font-semibold">Generate Ideas</button>
      <button id="analyzeIdeaBtn" class="w-full bg-gray-800 hover:bg-gray-700 py-2 rounded-lg font-semibold">Analyze My Idea</button>
      <button id="consultantBtn" class="w-full bg-gray-800 hover:bg-gray-700 py-2 rounded-lg font-semibold">Startup Consultant</button>
      <div id="previousChats" class="mt-4 text-sm text-gray-400"></div>
    </div>

    <!-- CONTENT AREA -->
    <div id="contentArea" class="flex-1 flex flex-col items-center justify-start p-6 overflow-y-auto"></div>
  </div>

  <script>
    // ---------- SUPABASE INIT ----------
    const SUPABASE_URL = "https://dqssjmxviqhbhporsvse.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc3NqbXh2aXFoYmhwb3JzdnNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTk1NzMsImV4cCI6MjA3ODE5NTU3M30.dHfs-wnNaqcSAar4ALjNDDuMOB0P1dn1kiW29N-xMr4";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const loginSection = document.getElementById("loginSection");
    const mainSection = document.getElementById("mainSection");
    const loginBtn = document.getElementById("loginBtn");
    const loginStatus = document.getElementById("loginStatus");
    const logoutBtn = document.getElementById("logoutBtn");
    const contentArea = document.getElementById("contentArea");
    const previousChats = document.getElementById("previousChats");

    let currentUser = null;
    let currentIdeaName = "";

    // ---------- LOGIN ----------
    async function checkSession() {
      const { data } = await client.auth.getSession();
      if (data.session) {
        currentUser = data.session.user;
        showMain();
        loadChats();
      }
    }
    checkSession();

    loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) {
        loginStatus.textContent = "âŒ Please fill in both fields.";
        return;
      }
      loginStatus.textContent = "â³ Signing in...";
      const { data, error } = await client.auth.signInWithPassword({ email, password });
      if (error) {
        if (error.message.includes("Invalid login")) {
          const { error: signUpErr } = await client.auth.signUp({ email, password });
          if (signUpErr) loginStatus.textContent = "âŒ " + signUpErr.message;
          else loginStatus.textContent = "âœ… Account created! Check your email.";
        } else loginStatus.textContent = "âŒ " + error.message;
      } else {
        currentUser = data.user;
        showMain();
        loadChats();
      }
    });

    logoutBtn.onclick = async () => {
      await client.auth.signOut();
      location.reload();
    };

    function showMain() {
      loginSection.classList.add("hidden");
      mainSection.classList.remove("hidden");
      logoutBtn.classList.remove("hidden");
    }

    // ---------- FEATURE BUTTONS ----------
    document.getElementById("generateIdeaBtn").onclick = () => loadGenerateUI();
    document.getElementById("analyzeIdeaBtn").onclick = () => loadAnalyzeUI();
    document.getElementById("consultantBtn").onclick = () => loadConsultantUI();

    // ---------- UI TEMPLATES ----------
    function loadGenerateUI() {
      contentArea.innerHTML = `
        <div class="glass w-full max-w-lg rounded-2xl p-6 mb-8 fixed bottom-4 left-1/2 -translate-x-1/2">
          <label class="block text-gray-300 font-semibold mb-2">Enter a topic or industry:</label>
          <input id="topicInput" type="text" placeholder="e.g. sustainable fashion, AI healthcare..."
            class="w-full bg-transparent border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-pink-500 outline-none mb-4"/>
          <button id="generateBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-500 text-white font-bold py-3 rounded-lg">Generate Ideas</button>
          <div id="ideasContainer" class="mt-8"></div>
        </div>`;
    }

    function loadAnalyzeUI() {
      contentArea.innerHTML = `
        <div class="glass w-full max-w-lg rounded-2xl p-6 mb-8 fixed bottom-4 left-1/2 -translate-x-1/2">
          <label class="block text-gray-300 font-semibold mb-2">Enter your idea to analyze:</label>
          <textarea id="ideaText" rows="3" placeholder="Describe your idea..."
            class="w-full bg-transparent border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-pink-500 outline-none mb-4"></textarea>
          <button id="analyzeBtn" class="w-full bg-gradient-to-r from-purple-600 to-pink-500 text-white font-bold py-3 rounded-lg">Analyze My Idea</button>
          <div id="analysisResult" class="mt-6"></div>
        </div>`;
    }

    function loadConsultantUI() {
      contentArea.innerHTML = `
        <div id="chatArea" class="flex flex-col w-full max-w-3xl h-[80vh] bg-gray-900 rounded-2xl p-4 overflow-y-auto mb-20"></div>
        <div class="fixed bottom-4 left-1/2 -translate-x-1/2 w-full max-w-3xl flex space-x-2">
          <input id="chatInput" type="text" placeholder="Ask Spark Consultant..."
            class="flex-1 bg-transparent border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-pink-500 outline-none"/>
          <button id="sendChat" class="bg-gradient-to-r from-purple-600 to-pink-500 text-white font-bold px-5 rounded-lg">Send</button>
        </div>`;
      loadChats();
    }

    // ---------- CHAT SYSTEM ----------
    async function loadChats() {
      if (!currentUser) return;
      const { data } = await client.from("consultant_chats").select("*").eq("user_email", currentUser.email);
      if (data && data.length) {
        previousChats.innerHTML = `<h3 class="font-semibold mb-2">ðŸ’¬ My Conversations</h3>` + 
          data.map(d => `<button class="block w-full text-left hover:text-pink-400" onclick="loadChat('${d.idea_name}')">${d.idea_name}</button>`).join("");
      } else {
        previousChats.innerHTML = `<p>No past chats yet.</p>`;
      }
    }

    async function loadChat(name) {
      currentIdeaName = name;
      const { data } = await client.from("consultant_chats").select("*").eq("user_email", currentUser.email).eq("idea_name", name).single();
      const chatArea = document.getElementById("chatArea");
      chatArea.innerHTML = "";
      data.messages.forEach(msg => {
        const bubble = document.createElement("div");
        bubble.className = `mb-2 p-3 rounded-lg ${msg.role === 'user' ? 'bg-pink-600 self-end' : 'bg-gray-700 self-start'}`;
        bubble.textContent = msg.content;
        chatArea.appendChild(bubble);
      });
    }

    document.addEventListener("click", async (e) => {
      if (e.target && e.target.id === "sendChat") {
        const input = document.getElementById("chatInput");
        const msg = input.value.trim();
        if (!msg) return;
        input.value = "";

        const chatArea = document.getElementById("chatArea");
        chatArea.innerHTML += `<div class='self-end bg-pink-600 p-3 rounded-lg mb-2'>${msg}</div>`;

        let name = currentIdeaName;
        if (!name) {
          const { data: existing } = await client.from("consultant_chats").select("idea_name").eq("user_email", currentUser.email);
          name = `Idea ${existing.length + 1}`;
          currentIdeaName = name;
          await client.from("consultant_chats").insert([{ user_email: currentUser.email, idea_name: name, messages: [] }]);
          loadChats();
        }

        const { data } = await fetch("https://spark-x4pk.onrender.com/consultant", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg }),
        }).then(r => r.json());

        chatArea.innerHTML += `<div class='self-start bg-gray-700 p-3 rounded-lg mb-2'>${data.reply}</div>`;
        chatArea.scrollTop = chatArea.scrollHeight;

        await client.rpc("append_message", { 
          email: currentUser.email, 
          idea_name: name, 
          message: { role: "user", content: msg },
          reply: { role: "assistant", content: data.reply }
        });
      }
    });
  </script>
</body>
</html>
